---
title: Change Root with Chroot
date: "2023-05-21T20:34:00"
template: "post"
draft: false
slug: "chroot"
category: "Blog"
tags:
  - "Unix"
  - "Security"
description: "Learn about what chroot is and how to create a chroot jail"
---

<br>

The first time I heard about chroot was during a test, where I placed program files into a dedicated directory that was somewhat isolated from the rest of the file system, with a file structure similar to the following:

```
/
├── bin
├── usr
├── var
├── lib
├── chrootjail
│   ├── bin
│   ├── lib
│   ├── ...
├── ...
```

![Tearable Mesh Animation](/media/chroot.png)
<br>

## What is `chroot`

_[chroot](https://en.wikipedia.org/wiki/Chroot)_ (think: change root) is an operation in unix and unix-like operating systems that allows users to change the root directory of a process and its children to a new location on the filesystem. 

When you chroot a process, you are essentially creating a new filesystem environment for that process and its children. Access to files and directories is restricted within the new root directory. The environment created by chroot is sometimes called a **chroot jail**.

## Demo: running `bash` in a chroot jail

The following is a demo of running `bash` in a chroot environment created at root directory `/` on Debian:

1. Copy the `bash` binary into the the new chroot root directory `/mychroot`:
  ```
  $ sudo mkdir -p /mychroot/bin
  $ sudo cp /bin/bash /mychroot/bin/
  ```
  This copies the binary file as well as any dependencies that are statically linked.

2. Check to see if there is any other dependencies that are dynamically linked.

  ```
  $ sudo ldd /bin/bash
  ```
  You should see something similar to the following:
  ```
  linux-vdso.so.1 (0x00007ffd807ec000)
  libtinfo.so.6 => /lib/x86_64-linux-gnu/libtinfo.so.6 (0x00007f00c86fa000)
  libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f00c86f4000)
  libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f00c8520000)
  /lib64/ld-linux-x86-64.so.2 (0x00007f00c8869000)
  ```
  The files with `=>` linking symbol are the dependencies dynamically linked, which should be copied to the `/mychroot` as well.

3. Copy the dynamically linked dependencies to `/mychroot`.

  ```
  $ sudo mkdir -p /mychroot/lib/x86_64-linux-gnu/
  $ sudo ldd /bin/bash | grep "=>" | awk '{print $3}' | xargs -I '{}' sudo cp -v '{}' /mychroot/lib/x86_64-linux-gnu/
  ```

  If successful, you should see something similar to:
  ```
  '/lib/x86_64-linux-gnu/libtinfo.so.6' -> '/mychroot/lib/x86_64-linux-gnu/libtinfo.so.6'
  '/lib/x86_64-linux-gnu/libdl.so.2' -> '/mychroot/lib/x86_64-linux-gnu/libdl.so.2'
  '/lib/x86_64-linux-gnu/libc.so.6' -> '/mychroot/lib/x86_64-linux-gnu/libc.so.6'
  ```

4. Start a new session in `/mychroot`:

  ```
  $ sudo chroot /mychroot
  ```

## Final words on chroot and security

While chroot is a quick approach to create a somewhat isolated filesystem, note that it was **not intended to be used as a security feature**. Chroot was originally designed provide a way to test and debug software in a controlled environment.

For example, chroot is not a complete isolation at the process or network level. A process with root access can easily exit the chroot jail and access resources outside. A process running within a chroot jail may still be able to access network resources outside of the jail, or interact with other processes running on the same system. 

Read about why chroot is not a security feature on [this blog by Red Hat](https://www.redhat.com/en/blog/chroot-security-feature).

If you are looking for a more isolated and secure environment, virtualization technologies such as containers or VMs may be more appropriate.
