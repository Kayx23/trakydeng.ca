---
title: Sandboxing with chroot
date: "2023-05-21T14:34:00"
template: "post"
draft: false
slug: "chroot"
category: "Blog"
tags:
  - "Unix"
  - "Security"
description: "Learn about what chroot is and how to create a chroot jail"
---

<br>

```
/
├── bin
├── usr
├── var
├── lib
├── mychroot
│   ├── bin
│   ├── lib
│   ├── ...
├── ...
```

## What is `chroot`

_[chroot](https://en.wikipedia.org/wiki/Chroot)_ is an operation in unix and unix-like operating systems that allows users to change the root directory of a process and its children to a new location on the filesystem. 

When you chroot a process, you are essentially creating a new filesystem environment for that process and its children. Access to files and directories is restricted within the new root directory. The sandboxed environment created by chroot is sometimes called a **chroot jail**, which is useful for a variety of purposes, such as security, testing, and recovery.

## Demo

The following is a demo of running `bash` in a sandboxed chroot environment.

1. Copy the `bash` binary into the the new chroot root directory `/mychroot`:
  ```
  $ sudo mkdir -p /mychroot/bin
  $ sudo cp /bin/bash /mychroot/bin/
  ```
  This copies the binary file as well as any dependencies that are statically linked.

2. Check to see if there is any other dependencies that are dynamically linked.

  ```
  $ sudo ldd /bin/bash
  ```
  You should see something similar to the following:
  ```
  linux-vdso.so.1 (0x00007ffd807ec000)
  libtinfo.so.6 => /lib/x86_64-linux-gnu/libtinfo.so.6 (0x00007f00c86fa000)
  libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f00c86f4000)
  libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f00c8520000)
  /lib64/ld-linux-x86-64.so.2 (0x00007f00c8869000)
  ```
  The files with `=>` linking symbol are the dependencies dynamically linked, which should be copied to the `/mychroot` as well.

3. Copy the dynamically linked dependencies to `/mychroot`.

  ```
  $ sudo mkdir -p /mychroot/lib/x86_64-linux-gnu/
  $ sudo ldd /bin/bash | grep "=>" | awk '{print $3}' | xargs -I '{}' sudo cp -v '{}' /mychroot/lib/x86_64-linux-gnu/
  ```

  If successful, you should see something similar to:
  ```
  '/lib/x86_64-linux-gnu/libtinfo.so.6' -> '/mychroot/lib/x86_64-linux-gnu/libtinfo.so.6'
  '/lib/x86_64-linux-gnu/libdl.so.2' -> '/mychroot/lib/x86_64-linux-gnu/libdl.so.2'
  '/lib/x86_64-linux-gnu/libc.so.6' -> '/mychroot/lib/x86_64-linux-gnu/libc.so.6'
  ```

4. Start a new session in `/mychroot`:

  ```
  $ sudo chroot /mychroot
  chroot: failed to run command ‘/bin/bash’: No such file or directory
  ```
????

https://unix.stackexchange.com/questions/746497/chroot-bash-not-working-after-copying-both-the-binary-and-its-dependancies


## Breaking out of Chroot Jail

Scenarios where you should not use chroot 

When dealing with network services: Chroot does not provide any network isolation, so it may not be sufficient for securing network services. Again, virtualization technologies such as containers or virtual machines may be more appropriate.

When dealing with privileged processes: Chroot can be bypassed by privileged processes, so it may not be suitable for securing highly sensitive processes that require root privileges. In such cases, more advanced security measures such as SELinux or AppArmor may be necessary.

Privilege escalation... pawned!

## Final Words

TBD
