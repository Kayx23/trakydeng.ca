---
title: Change Root with Chroot
date: "2023-05-21T20:34:00"
template: "post"
draft: false
slug: "chroot"
category: "Blog"
tags:
  - "Unix"
  - "Security"
description: "Learn about what chroot is and how to create a chroot jail"
---

<br>

The first time I heard about chroot was during a test, where I placed the test program files into a dedicated directory that was somewhat isolated from the rest of the file system. The file structure is similar to the following:

```
/
├── bin
├── usr
├── var
├── lib
├── chrootjail
│   ├── bin
│   ├── lib
│   ├── ...
├── ...
```

<div style='width:300px;background-color:transparent'>
<img src='/media/chroot.png'>
</div>

## What is `chroot`

[chroot](https://en.wikipedia.org/wiki/Chroot) (think: change root) is an operation in unix and unix-like operating systems that allows users to change the root directory of a process and its children to a new location on the filesystem. 

When you chroot a process, you are essentially creating a new filesystem environment for that process and its children. Access to files and directories is restricted within the new root directory. The environment created by chroot is sometimes called a **chroot jail**.

## Demo: running `bash` in a chroot jail

The following is a demo of running `bash` in a chroot environment created at root directory `/` on Debian:

1. Copy the `bash` binary into the the new chroot root directory `/mychroot`:
  ```
  $ sudo mkdir -p /mychroot/bin
  $ sudo cp /bin/bash /mychroot/bin/
  ```

2. Check bash binary dependencies:
  ```
  $ ldd /bin/bash
  ```
  You should see something similar to the following:
  ```
  linux-vdso.so.1 (0x00007ffd807ec000)
  libtinfo.so.6 => /lib/x86_64-linux-gnu/libtinfo.so.6 (0x00007f00c86fa000)
  libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f00c86f4000)
  libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f00c8520000)
  /lib64/ld-linux-x86-64.so.2 (0x00007f00c8869000)
  ```
  Theses files should be added to `/mychroot`.

3. Copy the dependencies into `/mychroot`.
  ```
  $ sudo mkdir -p /mychroot/lib/x86_64-linux-gnu/
  $ sudo cp -t /mychroot/lib/x86_64-linux-gnu /lib/x86_64-linux-gnu/libtinfo.so.6 /lib/x86_64-linux-gnu/libdl.so.2 /lib/x86_64-linux-gnu/libc.so.6 /lib64/ld-linux-x86-64.so.2
  ```

  --- this isnt working either?
  ```
  sudo cp -r /lib /lib64 /mychroot

  /mychroot$ ls -la
  drwxr-xr-x  3 root root 4096 May 21 14:51 .
  drwxr-xr-x 19 root root 4096 May 21 14:36 ..
  drwxr-xr-x  2 root root 4096 May 21 14:36 bin
  lrwxrwxrwx  1 root root    7 May 21 14:51 lib -> usr/lib
  lrwxrwxrwx  1 root root    9 May 21 14:51 lib64 -> usr/lib64
  ```

4. Start a new session in `/mychroot`:
  ```
  $ sudo chroot /mychroot
  ```

## Final words on security

While chroot is a quick approach to create a somewhat isolated filesystem, note that it was **not intended to be used as a security feature**. Chroot was originally designed provide a way to test and debug software in a controlled environment.

For example, chroot is not a complete isolation at the process or network level. A process with root access can easily exit the chroot jail and access resources outside. A process running within a chroot jail may still be able to access network resources outside of the jail, or interact with other processes running on the same system. 

Read about why chroot is not a security feature on [this blog by Red Hat](https://www.redhat.com/en/blog/chroot-security-feature).

If you are looking for a more isolated and secure environment, virtualization technologies such as containers or VMs may be more appropriate.
